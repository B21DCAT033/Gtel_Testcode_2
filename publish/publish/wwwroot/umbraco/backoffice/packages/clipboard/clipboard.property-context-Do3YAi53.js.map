{"version":3,"file":"clipboard.property-context-Do3YAi53.js","sources":["../../../src/packages/clipboard/property/context/clipboard.property-context.ts"],"sourcesContent":["import { UMB_CLIPBOARD_CONTEXT } from '../../context/index.js';\r\nimport {\r\n\tUMB_CLIPBOARD_ENTRY_PICKER_MODAL,\r\n\ttype UmbClipboardEntryDetailModel,\r\n\ttype UmbClipboardEntryValuesType,\r\n} from '../../clipboard-entry/index.js';\r\nimport type { ManifestClipboardPastePropertyValueTranslator } from '../value-translator/types.js';\r\nimport {\r\n\tUmbClipboardCopyPropertyValueTranslatorValueResolver,\r\n\tUmbClipboardPastePropertyValueTranslatorValueResolver,\r\n} from '../value-translator/index.js';\r\nimport { UMB_CLIPBOARD_PROPERTY_CONTEXT } from './clipboard.property-context-token.js';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport { UMB_PROPERTY_CONTEXT, UmbPropertyValueCloneController } from '@umbraco-cms/backoffice/property';\r\nimport { umbExtensionsRegistry } from '@umbraco-cms/backoffice/extension-registry';\r\nimport type { ManifestPropertyEditorUi } from '@umbraco-cms/backoffice/property-editor';\r\nimport type { UmbEntityUnique } from '@umbraco-cms/backoffice/entity';\r\n\r\n/**\r\n * Clipboard context for managing clipboard entries for property values\r\n * @export\r\n * @class UmbClipboardPropertyContext\r\n * @augments {UmbContextBase<UmbClipboardPropertyContext>}\r\n */\r\nexport class UmbClipboardPropertyContext extends UmbContextBase<UmbClipboardPropertyContext> {\r\n\t#init?: Promise<unknown>;\r\n\r\n\t#modalManagerContext?: typeof UMB_MODAL_MANAGER_CONTEXT.TYPE;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_CLIPBOARD_PROPERTY_CONTEXT);\r\n\r\n\t\tthis.#init = Promise.all([\r\n\t\t\tthis.consumeContext(UMB_MODAL_MANAGER_CONTEXT, (context) => {\r\n\t\t\t\tthis.#modalManagerContext = context;\r\n\t\t\t}).asPromise(),\r\n\t\t]);\r\n\t}\r\n\r\n\t/**\r\n\t * Read a clipboard entry for a property. The entry will be translated to the property editor value\r\n\t * @param {string} unique - The unique id of the clipboard entry\r\n\t * @param {string} propertyEditorUiAlias - The alias of the property editor to match\r\n\t * @returns { Promise<unknown> } - Returns the resolved property value\r\n\t */\r\n\tasync read<ReturnType = unknown>(unique: string, propertyEditorUiAlias: string): Promise<ReturnType | undefined> {\r\n\t\tif (!unique) throw new Error('The Clipboard Entry unique is required');\r\n\t\tif (!propertyEditorUiAlias) throw new Error('Property Editor UI alias is required');\r\n\t\tconst manifest = await this.#findPropertyEditorUiManifest(propertyEditorUiAlias);\r\n\t\treturn this.#resolvePropertyValue<ReturnType>(unique, manifest);\r\n\t}\r\n\r\n\t/**\r\n\t * Read multiple clipboard entries for a property. The entries will be translated to the property editor values\r\n\t * @param {Array<string>} uniques - The unique ids of the clipboard entries\r\n\t * @param {string} propertyEditorUiAlias - The alias of the property editor to match\r\n\t * @returns { Promise<Array<unknown>> } - Returns an array of resolved property values\r\n\t */\r\n\tasync readMultiple<ReturnType = unknown>(\r\n\t\tuniques: Array<string>,\r\n\t\tpropertyEditorUiAlias: string,\r\n\t): Promise<Array<ReturnType>> {\r\n\t\tif (!uniques || !uniques.length) {\r\n\t\t\tthrow new Error('Clipboard entry uniques are required');\r\n\t\t}\r\n\r\n\t\tconst promises = Promise.allSettled(uniques.map((unique) => this.read(unique, propertyEditorUiAlias)));\r\n\r\n\t\tconst readResult = await promises;\r\n\t\t// TODO:show message if some entries are not fulfilled\r\n\t\tconst fulfilledResult = readResult.filter((result) => result.status === 'fulfilled' && result.value) as Array<\r\n\t\t\tPromiseFulfilledResult<ReturnType>\r\n\t\t>;\r\n\t\t// Map the values and remove undefined.\r\n\t\tconst propertyValues = fulfilledResult.map((result) => result.value).filter((x) => x);\r\n\r\n\t\tif (!propertyValues.length) {\r\n\t\t\tthrow new Error('Failed to read clipboard entries');\r\n\t\t}\r\n\r\n\t\treturn propertyValues;\r\n\t}\r\n\r\n\t/**\r\n\t * Write a clipboard entry for a property. The property value will be translated to the clipboard entry values\r\n\t * @param args - Arguments for writing a clipboard entry\r\n\t * @param {string} args.name - The name of the clipboard entry\r\n\t * @param {string} args.icon - The icon of the clipboard entry\r\n\t * @param {any} args.propertyValue - The property value to write\r\n\t * @param {string} args.propertyEditorUiAlias - The alias of the property editor to match\r\n\t * @returns { Promise<void> }\r\n\t */\r\n\tasync write(args: {\r\n\t\tname: string;\r\n\t\ticon?: string;\r\n\t\tpropertyValue: any;\r\n\t\tpropertyEditorUiAlias: string;\r\n\t}): Promise<UmbClipboardEntryDetailModel | undefined> {\r\n\t\tconst clipboardContext = await this.getContext(UMB_CLIPBOARD_CONTEXT);\r\n\r\n\t\tconst copyValueResolver = new UmbClipboardCopyPropertyValueTranslatorValueResolver(this);\r\n\t\tconst values = await copyValueResolver.resolve(args.propertyValue, args.propertyEditorUiAlias);\r\n\r\n\t\tconst entryPreset: Partial<UmbClipboardEntryDetailModel> = {\r\n\t\t\tname: args.name,\r\n\t\t\tvalues,\r\n\t\t\ticon: args.icon,\r\n\t\t};\r\n\r\n\t\treturn await clipboardContext.write(entryPreset);\r\n\t}\r\n\r\n\t/**\r\n\t * Pick a clipboard entry for a property. The entry will be translated to the property editor value\r\n\t * @param args - Arguments for picking a clipboard entry\r\n\t * @param {boolean} args.multiple - Allow multiple clipboard entries to be picked\r\n\t * @param {string} args.propertyEditorUiAlias - The alias of the property editor to match\r\n\t * @returns { Promise<{ selection: Array<UmbEntityUnique>; propertyValues: Array<any> }> }\r\n\t */\r\n\tasync pick(args: {\r\n\t\tmultiple: boolean;\r\n\t\tpropertyEditorUiAlias: string;\r\n\t}): Promise<{ selection: Array<UmbEntityUnique>; propertyValues: Array<any> }> {\r\n\t\tawait this.#init;\r\n\r\n\t\tconst pasteTranslatorManifests = this.getPasteTranslatorManifests(args.propertyEditorUiAlias);\r\n\t\tconst propertyEditorUiManifest = await this.#findPropertyEditorUiManifest(args.propertyEditorUiAlias);\r\n\t\tconst config = (await this.getContext(UMB_PROPERTY_CONTEXT)).getConfig();\r\n\r\n\t\tconst valueResolver = new UmbClipboardPastePropertyValueTranslatorValueResolver(this);\r\n\r\n\t\tconst modal = this.#modalManagerContext?.open(this, UMB_CLIPBOARD_ENTRY_PICKER_MODAL, {\r\n\t\t\tdata: {\r\n\t\t\t\tasyncFilter: async (clipboardEntryDetail) => {\r\n\t\t\t\t\tconst hasSupportedPasteTranslator = this.hasSupportedPasteTranslator(\r\n\t\t\t\t\t\tpasteTranslatorManifests,\r\n\t\t\t\t\t\tclipboardEntryDetail.values,\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tif (!hasSupportedPasteTranslator) {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst pasteTranslator = await valueResolver.getPasteTranslator(\r\n\t\t\t\t\t\tclipboardEntryDetail.values,\r\n\t\t\t\t\t\tpropertyEditorUiManifest.alias,\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tif (pasteTranslator.isCompatibleValue) {\r\n\t\t\t\t\t\tconst value = await valueResolver.resolve(clipboardEntryDetail.values, propertyEditorUiManifest.alias);\r\n\t\t\t\t\t\treturn pasteTranslator.isCompatibleValue(value, config);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tconst result = await modal?.onSubmit();\r\n\t\tconst selection = result?.selection || [];\r\n\r\n\t\tif (!selection.length) {\r\n\t\t\tthrow new Error('No clipboard entry selected');\r\n\t\t}\r\n\r\n\t\tlet propertyValues: Array<any> = [];\r\n\r\n\t\tif (args.multiple) {\r\n\t\t\tthrow new Error('Multiple clipboard entries not supported');\r\n\t\t} else {\r\n\t\t\tconst selected = selection[0];\r\n\r\n\t\t\tif (!selected) {\r\n\t\t\t\tthrow new Error('No clipboard entry selected');\r\n\t\t\t}\r\n\r\n\t\t\tconst propertyValue = await this.#resolvePropertyValue(selected, propertyEditorUiManifest);\r\n\t\t\tpropertyValues = [propertyValue];\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tselection,\r\n\t\t\tpropertyValues,\r\n\t\t};\r\n\t}\r\n\r\n\tasync #findPropertyEditorUiManifest(alias: string): Promise<ManifestPropertyEditorUi> {\r\n\t\tconst manifest = umbExtensionsRegistry.getByAlias<ManifestPropertyEditorUi>(alias);\r\n\r\n\t\tif (!manifest) {\r\n\t\t\tthrow new Error(`Could not find property editor with alias: ${alias}`);\r\n\t\t}\r\n\r\n\t\tif (manifest.type !== 'propertyEditorUi') {\r\n\t\t\tthrow new Error(`Alias ${alias} is not a property editor ui`);\r\n\t\t}\r\n\r\n\t\treturn manifest;\r\n\t}\r\n\r\n\tasync #resolvePropertyValue<ValueType>(\r\n\t\tclipboardEntryUnique: string,\r\n\t\tpropertyEditorUiManifest: ManifestPropertyEditorUi,\r\n\t): Promise<ValueType | undefined> {\r\n\t\tif (!clipboardEntryUnique) {\r\n\t\t\tthrow new Error('Unique id is required');\r\n\t\t}\r\n\r\n\t\tif (!propertyEditorUiManifest.alias) {\r\n\t\t\tthrow new Error('Property Editor UI alias is required');\r\n\t\t}\r\n\r\n\t\tif (!propertyEditorUiManifest.meta.propertyEditorSchemaAlias) {\r\n\t\t\tthrow new Error('Property Editor UI Schema alias is required');\r\n\t\t}\r\n\r\n\t\tconst clipboardContext = await this.getContext(UMB_CLIPBOARD_CONTEXT);\r\n\t\tconst entry = await clipboardContext.read(clipboardEntryUnique);\r\n\r\n\t\tif (!entry) {\r\n\t\t\tthrow new Error(`Could not find clipboard entry with unique id: ${clipboardEntryUnique}`);\r\n\t\t}\r\n\r\n\t\tconst valueResolver = new UmbClipboardPastePropertyValueTranslatorValueResolver<ValueType>(this);\r\n\t\tconst propertyValue = await valueResolver.resolve(entry.values, propertyEditorUiManifest.alias);\r\n\r\n\t\tconst cloner = new UmbPropertyValueCloneController(this);\r\n\t\tconst clonedValue = await cloner.clone<ValueType>({\r\n\t\t\teditorAlias: propertyEditorUiManifest.meta.propertyEditorSchemaAlias,\r\n\t\t\talias: propertyEditorUiManifest.alias,\r\n\t\t\tvalue: propertyValue,\r\n\t\t});\r\n\r\n\t\treturn clonedValue.value;\r\n\t}\r\n\r\n\t/**\r\n\t * Get all clipboard paste translators for a property editor ui\r\n\t * @param {string} propertyEditorUiAlias - The alias of the property editor to match\r\n\t * @returns {Array<ManifestClipboardPastePropertyValueTranslator>} - Returns an array of clipboard paste translators\r\n\t */\r\n\tgetPasteTranslatorManifests(propertyEditorUiAlias: string) {\r\n\t\treturn umbExtensionsRegistry.getByTypeAndFilter(\r\n\t\t\t'clipboardPastePropertyValueTranslator',\r\n\t\t\t(manifest) => manifest.toPropertyEditorUi === propertyEditorUiAlias,\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * Check if the clipboard entry values has supported paste translator\r\n\t * @param {Array<ManifestClipboardPastePropertyValueTranslator>} manifests - The paste translator manifests\r\n\t * @param {UmbClipboardEntryValuesType} clipboardEntryValues - The clipboard entry values\r\n\t * @returns {boolean} - Returns true if the clipboard entry values has supported paste translator\r\n\t */\r\n\thasSupportedPasteTranslator(\r\n\t\tmanifests: Array<ManifestClipboardPastePropertyValueTranslator>,\r\n\t\tclipboardEntryValues: UmbClipboardEntryValuesType,\r\n\t): boolean {\r\n\t\tconst entryValueTypes = clipboardEntryValues.map((x) => x.type);\r\n\r\n\t\tconst supportedManifests = manifests.filter((manifest) => {\r\n\t\t\tconst canTranslateValue = entryValueTypes.includes(manifest.fromClipboardEntryValueType);\r\n\t\t\treturn canTranslateValue;\r\n\t\t});\r\n\r\n\t\treturn supportedManifests.length > 0;\r\n\t}\r\n}\r\n\r\nexport { UmbClipboardPropertyContext as api };\r\n"],"names":["UmbClipboardPropertyContext","UmbContextBase","#init","#modalManagerContext","host","UMB_CLIPBOARD_PROPERTY_CONTEXT","UMB_MODAL_MANAGER_CONTEXT","context","unique","propertyEditorUiAlias","manifest","#findPropertyEditorUiManifest","#resolvePropertyValue","uniques","propertyValues","result","x","args","clipboardContext","UMB_CLIPBOARD_CONTEXT","values","UmbClipboardCopyPropertyValueTranslatorValueResolver","entryPreset","pasteTranslatorManifests","propertyEditorUiManifest","config","UMB_PROPERTY_CONTEXT","valueResolver","UmbClipboardPastePropertyValueTranslatorValueResolver","selection","UMB_CLIPBOARD_ENTRY_PICKER_MODAL","clipboardEntryDetail","pasteTranslator","value","selected","alias","umbExtensionsRegistry","clipboardEntryUnique","entry","propertyValue","UmbPropertyValueCloneController","manifests","clipboardEntryValues","entryValueTypes"],"mappings":"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"}