{"version":3,"file":"composition-picker-modal.element-Bm03OTox.js","sources":["../../../src/packages/core/content-type/modals/composition-picker/composition-picker-modal.element.ts"],"sourcesContent":["import type {\r\n\tUmbContentTypeCompositionRepository,\r\n\tUmbContentTypeCompositionCompatibleModel,\r\n\tUmbContentTypeCompositionReferenceModel,\r\n} from '../../composition/index.js';\r\nimport type {\r\n\tUmbCompositionPickerModalData,\r\n\tUmbCompositionPickerModalValue,\r\n} from './composition-picker-modal.token.js';\r\nimport { css, html, customElement, state, repeat, nothing } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbModalBaseElement, umbConfirmModal } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbExtensionApiInitializer } from '@umbraco-cms/backoffice/extension-api';\r\nimport { umbExtensionsRegistry } from '@umbraco-cms/backoffice/extension-registry';\r\n\r\ninterface CompatibleCompositions {\r\n\tpath: string;\r\n\tcompositions: Array<UmbContentTypeCompositionCompatibleModel>;\r\n}\r\n\r\n@customElement('umb-composition-picker-modal')\r\nexport class UmbCompositionPickerModalElement extends UmbModalBaseElement<\r\n\tUmbCompositionPickerModalData,\r\n\tUmbCompositionPickerModalValue\r\n> {\r\n\t// TODO: Loosen this from begin specific to Document Types, so we can have a general interface for composition repositories. [NL]\r\n\t#compositionRepository?: UmbContentTypeCompositionRepository;\r\n\t#unique: string | null = null;\r\n\t#init?: Promise<void>;\r\n\r\n\t@state()\r\n\tprivate _references: Array<UmbContentTypeCompositionReferenceModel> = [];\r\n\r\n\t@state()\r\n\tprivate _compatibleCompositions?: Array<CompatibleCompositions>;\r\n\r\n\t@state()\r\n\tprivate _selection: Array<string> = [];\r\n\toverride connectedCallback() {\r\n\t\tsuper.connectedCallback();\r\n\r\n\t\tconst alias = this.data?.compositionRepositoryAlias;\r\n\t\tif (alias) {\r\n\t\t\tthis.#init = new UmbExtensionApiInitializer(this, umbExtensionsRegistry, alias, [this], (permitted, ctrl) => {\r\n\t\t\t\tthis.#compositionRepository = permitted ? (ctrl.api as UmbContentTypeCompositionRepository) : undefined;\r\n\t\t\t}).asPromise();\r\n\t\t} else {\r\n\t\t\tthrow new Error('No composition repository alias provided');\r\n\t\t}\r\n\r\n\t\tthis._selection = this.data?.selection ?? [];\r\n\t\tthis.modalContext?.setValue({ selection: this._selection });\r\n\r\n\t\tconst isNew = this.data!.isNew;\r\n\t\tthis.#unique = !isNew ? this.data!.unique : null;\r\n\r\n\t\tthis.#requestReference();\r\n\t\tthis.#requestAvailableCompositions();\r\n\t}\r\n\r\n\tprotected override async _submitModal() {\r\n\t\tconst initSelection = this.data?.selection ?? [];\r\n\t\tconst newSelection = this._selection;\r\n\r\n\t\tconst setA = new Set(newSelection);\r\n\t\tconst existingCompositionHasBeenRemoved = !initSelection.every((item) => setA.has(item));\r\n\r\n\t\tif (existingCompositionHasBeenRemoved) {\r\n\t\t\tawait umbConfirmModal(this, {\r\n\t\t\t\theadline: this.localize.term('general_remove'),\r\n\t\t\t\tcontent: html`<div style=\"max-width:400px\">\r\n\t\t\t\t\t${this.localize.term('contentTypeEditor_compositionRemoveWarning')}\r\n\t\t\t\t</div>`,\r\n\t\t\t\tconfirmLabel: this.localize.term('general_submit'),\r\n\t\t\t\tcolor: 'danger',\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tsuper._submitModal();\r\n\t}\r\n\r\n\tasync #requestReference() {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#unique || !this.#compositionRepository) return;\r\n\r\n\t\tconst { data } = await this.#compositionRepository.getReferences(this.#unique);\r\n\t\tthis._references = data ?? [];\r\n\t}\r\n\r\n\tasync #requestAvailableCompositions() {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#compositionRepository) return;\r\n\r\n\t\t// Notice isElement is not available on all types that can be composed.\r\n\t\tconst isElement = this.data?.isElement ?? undefined;\r\n\t\tconst currentPropertyAliases = this.data?.currentPropertyAliases ?? [];\r\n\r\n\t\tconst { data } = await this.#compositionRepository.availableCompositions({\r\n\t\t\tunique: this.#unique,\r\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n\t\t\t// @ts-ignore\r\n\t\t\t// TODO: isElement is not available on all types that can be composed.\r\n\t\t\tisElement: isElement,\r\n\t\t\tcurrentCompositeUniques: this._selection,\r\n\t\t\tcurrentPropertyAliases: currentPropertyAliases,\r\n\t\t});\r\n\r\n\t\tif (!data) return;\r\n\r\n\t\tconst folders = Array.from(new Set(data.map((c) => '/' + c.folderPath.join('/'))));\r\n\t\tthis._compatibleCompositions = folders.map((path) => ({\r\n\t\t\tpath,\r\n\t\t\tcompositions: data.filter((c) => '/' + c.folderPath.join('/') === path),\r\n\t\t}));\r\n\t}\r\n\r\n\t#onSelectionAdd(unique: string) {\r\n\t\tthis._selection = [...this._selection, unique];\r\n\t\tthis.modalContext?.setValue({ selection: this._selection });\r\n\t}\r\n\r\n\t#onSelectionRemove(unique: string) {\r\n\t\tthis._selection = this._selection.filter((s) => s !== unique);\r\n\t\tthis.modalContext?.setValue({ selection: this._selection });\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn html`\r\n\t\t\t<umb-body-layout headline=\"${this.localize.term('contentTypeEditor_compositions')}\">\r\n\t\t\t\t${this._references.length ? this.#renderHasReference() : this.#renderAvailableCompositions()}\r\n\t\t\t\t<div slot=\"actions\">\r\n\t\t\t\t\t<uui-button label=${this.localize.term('general_close')} @click=${this._rejectModal}></uui-button>\r\n\t\t\t\t\t${!this._references.length\r\n\t\t\t\t\t\t? html`\r\n\t\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\t\tlabel=${this.localize.term('general_submit')}\r\n\t\t\t\t\t\t\t\t\tlook=\"primary\"\r\n\t\t\t\t\t\t\t\t\tcolor=\"positive\"\r\n\t\t\t\t\t\t\t\t\t@click=${this._submitModal}></uui-button>\r\n\t\t\t\t\t\t\t`\r\n\t\t\t\t\t\t: nothing}\r\n\t\t\t\t</div>\r\n\t\t\t</umb-body-layout>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderHasReference() {\r\n\t\treturn html`\r\n\t\t\t<umb-localize key=\"contentTypeEditor_compositionInUse\">\r\n\t\t\t\tThis Content Type is used in a composition, and therefore cannot be composed itself.\r\n\t\t\t</umb-localize>\r\n\t\t\t<h4>\r\n\t\t\t\t<umb-localize key=\"contentTypeEditor_compositionUsageHeading\">Where is this composition used?</umb-localize>\r\n\t\t\t</h4>\r\n\t\t\t<umb-localize key=\"contentTypeEditor_compositionUsageSpecification\">\r\n\t\t\t\tThis composition is currently used in the composition of the following Content Types:\r\n\t\t\t</umb-localize>\r\n\t\t\t<div class=\"reference-list\">\r\n\t\t\t\t${repeat(\r\n\t\t\t\t\tthis._references,\r\n\t\t\t\t\t(item) => item.unique,\r\n\t\t\t\t\t(item) => html`\r\n\t\t\t\t\t\t<uui-ref-node-document-type\r\n\t\t\t\t\t\t\thref=${'/section/settings/workspace/document-type/edit/' + item.unique}\r\n\t\t\t\t\t\t\tname=${this.localize.string(item.name)}>\r\n\t\t\t\t\t\t\t<umb-icon slot=\"icon\" name=${item.icon}></umb-icon>\r\n\t\t\t\t\t\t</uui-ref-node-document-type>\r\n\t\t\t\t\t`,\r\n\t\t\t\t)}\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderAvailableCompositions() {\r\n\t\tif (this._compatibleCompositions) {\r\n\t\t\treturn html`\r\n\t\t\t\t<umb-localize key=\"contentTypeEditor_compositionsDescription\">\r\n\t\t\t\t\tInherit tabs and properties from an existing Document Type. New tabs will be<br />added to the current\r\n\t\t\t\t\tDocument Type or merged if a tab with an identical name exists.<br />\r\n\t\t\t\t</umb-localize>\r\n\t\t\t\t<!--- TODO: Implement search functionality\r\n\t\t\t\t<uui-input id=\"search\" placeholder=this.localize.term('placeholders_filter')>\r\n\t\t\t\t\t<uui-icon name=\"icon-search\" slot=\"prepend\"></uui-icon>\r\n\t\t\t\t</uui-input> -->\r\n\t\t\t\t<div class=\"compositions-list\">\r\n\t\t\t\t\t${repeat(\r\n\t\t\t\t\t\tthis._compatibleCompositions,\r\n\t\t\t\t\t\t(folder) => folder.path,\r\n\t\t\t\t\t\t(folder) =>\r\n\t\t\t\t\t\t\thtml`${this._compatibleCompositions!.length > 1\r\n\t\t\t\t\t\t\t\t? html`<strong><umb-icon name=\"icon-folder\"></umb-icon>${folder.path}</strong>`\r\n\t\t\t\t\t\t\t\t: nothing}\r\n\t\t\t\t\t\t\t${this.#renderCompositionsItems(folder.compositions)}`,\r\n\t\t\t\t\t)}\r\n\t\t\t\t</div>\r\n\t\t\t`;\r\n\t\t} else {\r\n\t\t\treturn html`\r\n\t\t\t\t<umb-localize key=\"contentTypeEditor_noAvailableCompositions\">\r\n\t\t\t\t\tThere are no Content Types available to use as a composition\r\n\t\t\t\t</umb-localize>\r\n\t\t\t`;\r\n\t\t}\r\n\t}\r\n\r\n\t#renderCompositionsItems(compositionsList: Array<UmbContentTypeCompositionCompatibleModel>) {\r\n\t\treturn repeat(\r\n\t\t\tcompositionsList,\r\n\t\t\t(compositions) => compositions.unique,\r\n\t\t\t(compositions) => html`\r\n\t\t\t\t<uui-menu-item\r\n\t\t\t\t\tlabel=${this.localize.string(compositions.name)}\r\n\t\t\t\t\tselectable\r\n\t\t\t\t\t@selected=${() => this.#onSelectionAdd(compositions.unique)}\r\n\t\t\t\t\t@deselected=${() => this.#onSelectionRemove(compositions.unique)}\r\n\t\t\t\t\t?selected=${this._selection.find((unique) => unique === compositions.unique)}>\r\n\t\t\t\t\t<umb-icon name=${compositions.icon} slot=\"icon\"></umb-icon>\r\n\t\t\t\t</uui-menu-item>\r\n\t\t\t`,\r\n\t\t);\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tcss`\r\n\t\t\tuui-input {\r\n\t\t\t\tmargin: var(--uui-size-6) 0;\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t}\r\n\r\n\t\t\t#search uui-icon {\r\n\t\t\t\tpadding-left: var(--uui-size-3);\r\n\t\t\t}\r\n\r\n\t\t\t.reference-list {\r\n\t\t\t\tmargin-block: var(--uui-size-3);\r\n\t\t\t\tdisplay: grid;\r\n\t\t\t\tgap: var(--uui-size-1);\r\n\t\t\t}\r\n\r\n\t\t\t.compositions-list strong {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-3);\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UmbCompositionPickerModalElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-composition-picker-modal': UmbCompositionPickerModalElement;\r\n\t}\r\n}\r\n"],"names":["_compositionRepository","_unique","_init","_UmbCompositionPickerModalElement_instances","requestReference_fn","requestAvailableCompositions_fn","onSelectionAdd_fn","onSelectionRemove_fn","renderHasReference_fn","renderAvailableCompositions_fn","renderCompositionsItems_fn","UmbCompositionPickerModalElement","UmbModalBaseElement","__privateAdd","alias","__privateSet","UmbExtensionApiInitializer","umbExtensionsRegistry","permitted","ctrl","isNew","__privateMethod","initSelection","newSelection","setA","item","umbConfirmModal","html","nothing","__privateGet","data","isElement","currentPropertyAliases","folders","c","path","unique","s","repeat","folder","compositionsList","compositions","css","__decorateClass","state","customElement","UmbCompositionPickerModalElement$1"],"mappings":"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"}