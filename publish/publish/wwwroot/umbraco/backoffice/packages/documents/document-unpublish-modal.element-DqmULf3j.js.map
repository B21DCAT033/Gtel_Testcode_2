{"version":3,"file":"document-unpublish-modal.element-DqmULf3j.js","sources":["../../../src/packages/documents/documents/publishing/unpublish/modal/document-unpublish-modal.element.ts"],"sourcesContent":["import { UmbDocumentVariantState, type UmbDocumentVariantOptionModel } from '../../../types.js';\r\nimport { UmbDocumentReferenceRepository } from '../../../reference/index.js';\r\nimport { UMB_DOCUMENT_CONFIGURATION_CONTEXT } from '../../../global-contexts/index.js';\r\nimport type {\r\n\tUmbDocumentUnpublishModalData,\r\n\tUmbDocumentUnpublishModalValue,\r\n} from './document-unpublish-modal.token.js';\r\nimport { css, customElement, html, nothing, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbModalBaseElement } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\nimport { UmbSelectionManager } from '@umbraco-cms/backoffice/utils';\r\n\r\nimport '../../../modals/shared/document-variant-language-picker.element.js';\r\n\r\n/**\r\n * @function isPublished\r\n * @param {UmbDocumentVariantOptionModel} option - the option to check.\r\n * @returns {boolean} boolean\r\n */\r\nexport function isPublished(option: UmbDocumentVariantOptionModel): boolean {\r\n\treturn (\r\n\t\toption.variant?.state === UmbDocumentVariantState.PUBLISHED ||\r\n\t\toption.variant?.state === UmbDocumentVariantState.PUBLISHED_PENDING_CHANGES\r\n\t);\r\n}\r\n\r\n@customElement('umb-document-unpublish-modal')\r\nexport class UmbDocumentUnpublishModalElement extends UmbModalBaseElement<\r\n\tUmbDocumentUnpublishModalData,\r\n\tUmbDocumentUnpublishModalValue\r\n> {\r\n\tprotected readonly _selectionManager = new UmbSelectionManager<string>(this);\r\n\t#referencesRepository = new UmbDocumentReferenceRepository(this);\r\n\r\n\t@state()\r\n\t_options: Array<UmbDocumentVariantOptionModel> = [];\r\n\r\n\t@state()\r\n\t_selection: Array<string> = [];\r\n\r\n\t@state()\r\n\t_hasReferences = false;\r\n\r\n\t@state()\r\n\t_hasUnpublishPermission = true;\r\n\r\n\t@state()\r\n\t_hasInvalidSelection = true;\r\n\r\n\t@state()\r\n\t_isInvariant = false;\r\n\r\n\t#pickableFilter = (option: UmbDocumentVariantOptionModel) => {\r\n\t\tif (!option.variant) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\treturn this.data?.pickableFilter ? this.data.pickableFilter(option) : true;\r\n\t};\r\n\r\n\toverride firstUpdated() {\r\n\t\tthis.#getReferences();\r\n\r\n\t\t// If invariant, don't display the variant selection component.\r\n\t\tif (this.data?.options.length === 1 && this.data.options[0].unique === 'invariant') {\r\n\t\t\tthis._isInvariant = true;\r\n\t\t\tthis._hasInvalidSelection = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.#configureSelectionManager();\r\n\t}\r\n\r\n\tasync #configureSelectionManager() {\r\n\t\tthis._selectionManager.setMultiple(true);\r\n\t\tthis._selectionManager.setSelectable(true);\r\n\r\n\t\t// Only display variants that are relevant to pick from, i.e. variants that are published or published with pending changes.\r\n\t\t// If we don't know the state (e.g. from a bulk publishing selection) we need to consider it available for selection.\r\n\t\tthis._options =\r\n\t\t\tthis.data?.options.filter((option) => (option.variant && option.variant.state === null) || isPublished(option)) ??\r\n\t\t\t[];\r\n\r\n\t\tlet selected = this.value?.selection ?? [];\r\n\r\n\t\tconst validOptions = this._options.filter((o) => this.#pickableFilter(o));\r\n\r\n\t\t// Filter selection based on options:\r\n\t\tselected = selected.filter((s) => validOptions.some((o) => o.unique === s));\r\n\r\n\t\tthis._selectionManager.setSelection(selected);\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis._selectionManager.selection,\r\n\t\t\t(selection) => {\r\n\t\t\t\tthis._selection = selection;\r\n\t\t\t\tconst selectionHasMandatory = this._options.some((o) => o.language.isMandatory && selection.includes(o.unique));\r\n\t\t\t\tconst selectionDoesNotHaveAllMandatory = this._options.some(\r\n\t\t\t\t\t(o) => o.language.isMandatory && !selection.includes(o.unique),\r\n\t\t\t\t);\r\n\t\t\t\tthis._hasInvalidSelection = selectionHasMandatory && selectionDoesNotHaveAllMandatory;\r\n\t\t\t},\r\n\t\t\t'observeSelection',\r\n\t\t);\r\n\t}\r\n\r\n\tasync #getReferences() {\r\n\t\tif (!this.data?.documentUnique) return;\r\n\r\n\t\tconst { data, error } = await this.#referencesRepository.requestReferencedBy(this.data?.documentUnique, 0, 1);\r\n\r\n\t\tif (error) {\r\n\t\t\tconsole.error(error);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (!data) return;\r\n\r\n\t\tthis._hasReferences = data.total > 0;\r\n\r\n\t\t// If there are references, we also want to check if we are allowed to unpublish the document:\r\n\t\tif (this._hasReferences) {\r\n\t\t\tconst documentConfigurationContext = await this.getContext(UMB_DOCUMENT_CONFIGURATION_CONTEXT);\r\n\t\t\tthis._hasUnpublishPermission =\r\n\t\t\t\t(await documentConfigurationContext.getDocumentConfiguration())?.disableUnpublishWhenReferenced === false;\r\n\t\t}\r\n\t}\r\n\r\n\t#submit() {\r\n\t\tif (this._hasUnpublishPermission) {\r\n\t\t\tconst selection = this._isInvariant ? ['invariant'] : this._selection;\r\n\t\t\tthis.value = { selection };\r\n\t\t\tthis.modalContext?.submit();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.modalContext?.reject();\r\n\t}\r\n\r\n\t#close() {\r\n\t\tthis.modalContext?.reject();\r\n\t}\r\n\r\n\tprivate _requiredFilter = (variantOption: UmbDocumentVariantOptionModel): boolean => {\r\n\t\treturn variantOption.language.isMandatory && !this._selection.includes(variantOption.unique);\r\n\t};\r\n\r\n\toverride render() {\r\n\t\treturn html`<umb-body-layout headline=${this.localize.term('content_unpublish')}>\r\n\t\t\t${!this._isInvariant\r\n\t\t\t\t? html`\r\n\t\t\t\t\t\t<p id=\"subtitle\">\r\n\t\t\t\t\t\t\t<umb-localize key=\"content_languagesToUnpublish\">\r\n\t\t\t\t\t\t\t\tSelect the languages to unpublish. Unpublishing a mandatory language will unpublish all languages.\r\n\t\t\t\t\t\t\t</umb-localize>\r\n\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t<umb-document-variant-language-picker\r\n\t\t\t\t\t\t\t.selectionManager=${this._selectionManager}\r\n\t\t\t\t\t\t\t.variantLanguageOptions=${this._options}\r\n\t\t\t\t\t\t\t.requiredFilter=${this._hasInvalidSelection ? this._requiredFilter : undefined}\r\n\t\t\t\t\t\t\t.pickableFilter=${this.#pickableFilter}></umb-document-variant-language-picker>\r\n\t\t\t\t\t`\r\n\t\t\t\t: nothing}\r\n\r\n\t\t\t<p>\r\n\t\t\t\t<umb-localize key=\"prompt_confirmUnpublish\">\r\n\t\t\t\t\tUnpublishing will remove this page and all its descendants from the site.\r\n\t\t\t\t</umb-localize>\r\n\t\t\t</p>\r\n\r\n\t\t\t${this.data?.documentUnique\r\n\t\t\t\t? html`\r\n\t\t\t\t\t\t<umb-document-reference-table\r\n\t\t\t\t\t\t\tid=\"references\"\r\n\t\t\t\t\t\t\tunique=${this.data?.documentUnique}></umb-document-reference-table>\r\n\t\t\t\t\t`\r\n\t\t\t\t: nothing}\r\n\t\t\t${this._hasReferences\r\n\t\t\t\t? html`<uui-box id=\"references-warning\">\r\n\t\t\t\t\t\t<umb-localize key=\"references_unpublishWarning\">\r\n\t\t\t\t\t\t\tThis item or its descendants is being referenced. Unpublishing can lead to broken links on your website.\r\n\t\t\t\t\t\t\tPlease take the appropriate actions.\r\n\t\t\t\t\t\t</umb-localize>\r\n\t\t\t\t\t</uui-box>`\r\n\t\t\t\t: nothing}\r\n\r\n\t\t\t<div slot=\"actions\">\r\n\t\t\t\t<uui-button label=${this.localize.term('general_close')} @click=${this.#close}></uui-button>\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tlabel=\"${this.localize.term('actions_unpublish')}\"\r\n\t\t\t\t\t?disabled=${this._hasInvalidSelection ||\r\n\t\t\t\t\t!this._hasUnpublishPermission ||\r\n\t\t\t\t\t(!this._isInvariant && this._selection.length === 0)}\r\n\t\t\t\t\tlook=\"primary\"\r\n\t\t\t\t\tcolor=\"warning\"\r\n\t\t\t\t\t@click=${this.#submit}></uui-button>\r\n\t\t\t</div>\r\n\t\t</umb-body-layout> `;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t\tmin-width: 600px;\r\n\t\t\t\tmax-width: 90vw;\r\n\t\t\t}\r\n\r\n\t\t\t#references {\r\n\t\t\t\t--uui-table-cell-padding: 0;\r\n\t\t\t}\r\n\r\n\t\t\t#references-warning {\r\n\t\t\t\tmargin-top: 1rem;\r\n\t\t\t\tbackground-color: var(--uui-color-danger);\r\n\t\t\t\tcolor: var(--uui-color-danger-contrast);\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UmbDocumentUnpublishModalElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-document-unpublish-modal': UmbDocumentUnpublishModalElement;\r\n\t}\r\n}\r\n"],"names":["_referencesRepository","_pickableFilter","_UmbDocumentUnpublishModalElement_instances","configureSelectionManager_fn","getReferences_fn","submit_fn","close_fn","isPublished","option","UmbDocumentVariantState","UmbDocumentUnpublishModalElement","UmbModalBaseElement","__privateAdd","UmbSelectionManager","UmbDocumentReferenceRepository","variantOption","__privateMethod","html","nothing","__privateGet","selected","validOptions","o","s","selection","selectionHasMandatory","selectionDoesNotHaveAllMandatory","data","error","documentConfigurationContext","UMB_DOCUMENT_CONFIGURATION_CONTEXT","UmbTextStyles","css","__decorateClass","state","customElement","UmbDocumentUnpublishModalElement$1"],"mappings":"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"}