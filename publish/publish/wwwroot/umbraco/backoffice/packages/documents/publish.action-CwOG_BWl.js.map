{"version":3,"file":"publish.action-CwOG_BWl.js","sources":["../../../src/packages/documents/documents/publishing/publish/entity-action/publish.action.ts"],"sourcesContent":["import type { UmbDocumentVariantOptionModel } from '../../../types.js';\r\nimport { UMB_DOCUMENT_PUBLISH_MODAL } from '../modal/constants.js';\r\nimport { UmbDocumentDetailRepository } from '../../../repository/index.js';\r\nimport { UmbDocumentPublishingRepository } from '../../repository/index.js';\r\nimport { UMB_APP_LANGUAGE_CONTEXT, UmbLanguageCollectionRepository } from '@umbraco-cms/backoffice/language';\r\nimport type { UmbEntityActionArgs } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbEntityActionBase, UmbRequestReloadStructureForEntityEvent } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport { UMB_CURRENT_USER_CONTEXT } from '@umbraco-cms/backoffice/current-user';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\n\r\nexport class UmbPublishDocumentEntityAction extends UmbEntityActionBase<never> {\r\n\tconstructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n\t\tsuper(host, args);\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tif (!this.args.unique) throw new Error('The document unique identifier is missing');\r\n\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst localize = new UmbLocalizationController(this);\r\n\r\n\t\tconst languageRepository = new UmbLanguageCollectionRepository(this._host);\r\n\t\tconst { data: languageData } = await languageRepository.requestCollection({});\r\n\r\n\t\tconst documentRepository = new UmbDocumentDetailRepository(this._host);\r\n\t\tconst { data: documentData } = await documentRepository.requestByUnique(this.args.unique);\r\n\r\n\t\tif (!documentData) throw new Error('The document was not found');\r\n\r\n\t\tconst appLanguageContext = await this.getContext(UMB_APP_LANGUAGE_CONTEXT);\r\n\t\tconst appCulture = appLanguageContext.getAppCulture();\r\n\r\n\t\tconst currentUserContext = await this.getContext(UMB_CURRENT_USER_CONTEXT);\r\n\t\tconst currentUserAllowedLanguages = currentUserContext.getLanguages();\r\n\t\tconst currentUserHasAccessToAllLanguages = currentUserContext.getHasAccessToAllLanguages();\r\n\r\n\t\tif (currentUserAllowedLanguages === undefined) throw new Error('The current user languages are missing');\r\n\t\tif (currentUserHasAccessToAllLanguages === undefined)\r\n\t\t\tthrow new Error('The current user access to all languages is missing');\r\n\r\n\t\tconst options: Array<UmbDocumentVariantOptionModel> = documentData.variants.map<UmbDocumentVariantOptionModel>(\r\n\t\t\t(variant) => ({\r\n\t\t\t\tculture: variant.culture,\r\n\t\t\t\tsegment: variant.segment,\r\n\t\t\t\tlanguage: languageData?.items.find((language) => language.unique === variant.culture) ?? {\r\n\t\t\t\t\tname: appCulture!,\r\n\t\t\t\t\tentityType: 'language',\r\n\t\t\t\t\tfallbackIsoCode: null,\r\n\t\t\t\t\tisDefault: true,\r\n\t\t\t\t\tisMandatory: false,\r\n\t\t\t\t\tunique: appCulture!,\r\n\t\t\t\t},\r\n\t\t\t\tvariant,\r\n\t\t\t\tunique: new UmbVariantId(variant.culture, variant.segment).toString(),\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tconst actionEventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\tconst event = new UmbRequestReloadStructureForEntityEvent({\r\n\t\t\tunique: this.args.unique,\r\n\t\t\tentityType: this.args.entityType,\r\n\t\t});\r\n\r\n\t\t// If the document has only one variant, we can skip the modal and publish directly:\r\n\t\tif (options.length === 1) {\r\n\t\t\tconst variantId = UmbVariantId.Create(documentData.variants[0]);\r\n\t\t\tconst publishingRepository = new UmbDocumentPublishingRepository(this._host);\r\n\t\t\tconst { error } = await publishingRepository.publish(this.args.unique, [{ variantId }]);\r\n\t\t\tif (!error) {\r\n\t\t\t\tnotificationContext.peek('positive', {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\theadline: localize.term('speechBubbles_editContentPublishedHeader'),\r\n\t\t\t\t\t\tmessage: localize.term('speechBubbles_editContentPublishedText'),\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tactionEventContext.dispatchEvent(event);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Figure out the default selections\r\n\t\t// TODO: Missing features to pre-select the variant that fits with the variant-id of the tree/collection? (Again only relevant if the action is executed from a Tree or Collection) [NL]\r\n\t\tconst selection: Array<string> = [];\r\n\t\t// If the app language is one of the options, select it by default:\r\n\t\tif (appCulture && options.some((o) => o.unique === appCulture)) {\r\n\t\t\tselection.push(new UmbVariantId(appCulture, null).toString());\r\n\t\t} else {\r\n\t\t\t// If not, select the first option by default:\r\n\t\t\tselection.push(options[0].unique);\r\n\t\t}\r\n\r\n\t\tconst modalManagerContext = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n\t\tconst result = await modalManagerContext\r\n\t\t\t.open(this, UMB_DOCUMENT_PUBLISH_MODAL, {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tpickableFilter: (option) => {\r\n\t\t\t\t\t\tif (!option.culture) return false;\r\n\t\t\t\t\t\tif (currentUserHasAccessToAllLanguages) return true;\r\n\t\t\t\t\t\treturn currentUserAllowedLanguages.includes(option.culture);\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tvalue: { selection },\r\n\t\t\t})\r\n\t\t\t.onSubmit()\r\n\t\t\t.catch(() => undefined);\r\n\r\n\t\tif (!result?.selection.length) return;\r\n\r\n\t\tconst variantIds = result?.selection.map((x) => UmbVariantId.FromString(x)) ?? [];\r\n\r\n\t\tif (variantIds.length) {\r\n\t\t\tconst publishingRepository = new UmbDocumentPublishingRepository(this._host);\r\n\t\t\tconst { error } = await publishingRepository.publish(\r\n\t\t\t\tthis.args.unique,\r\n\t\t\t\tvariantIds.map((variantId) => ({ variantId })),\r\n\t\t\t);\r\n\r\n\t\t\tif (!error) {\r\n\t\t\t\tconst documentVariants = documentData.variants.filter((variant) => result.selection.includes(variant.culture!));\r\n\t\t\t\tnotificationContext.peek('positive', {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\theadline: localize.term('speechBubbles_editContentPublishedHeader'),\r\n\t\t\t\t\t\tmessage: localize.term(\r\n\t\t\t\t\t\t\t'speechBubbles_editVariantPublishedText',\r\n\t\t\t\t\t\t\tlocalize.list(documentVariants.map((v) => v.culture ?? v.name)),\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tactionEventContext.dispatchEvent(event);\r\n\t\t}\r\n\t}\r\n}\r\nexport default UmbPublishDocumentEntityAction;\r\n"],"names":["UmbPublishDocumentEntityAction","UmbEntityActionBase","host","args","notificationContext","UMB_NOTIFICATION_CONTEXT","localize","UmbLocalizationController","languageRepository","UmbLanguageCollectionRepository","languageData","documentRepository","UmbDocumentDetailRepository","documentData","appCulture","UMB_APP_LANGUAGE_CONTEXT","currentUserContext","UMB_CURRENT_USER_CONTEXT","currentUserAllowedLanguages","currentUserHasAccessToAllLanguages","options","variant","language","UmbVariantId","actionEventContext","UMB_ACTION_EVENT_CONTEXT","event","UmbRequestReloadStructureForEntityEvent","variantId","publishingRepository","UmbDocumentPublishingRepository","error","selection","o","result","UMB_MODAL_MANAGER_CONTEXT","UMB_DOCUMENT_PUBLISH_MODAL","option","variantIds","x","documentVariants","v"],"mappings":"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"}