{"version":3,"file":"unpublish.action-CxVyMGWI.js","sources":["../../../src/packages/documents/documents/publishing/unpublish/entity-action/unpublish.action.ts"],"sourcesContent":["import type { UmbDocumentVariantOptionModel } from '../../../types.js';\r\nimport { UMB_DOCUMENT_UNPUBLISH_MODAL } from '../constants.js';\r\nimport { UmbDocumentDetailRepository } from '../../../repository/index.js';\r\nimport { UmbDocumentPublishingRepository } from '../../repository/index.js';\r\nimport { UMB_APP_LANGUAGE_CONTEXT, UmbLanguageCollectionRepository } from '@umbraco-cms/backoffice/language';\r\nimport {\r\n\ttype UmbEntityActionArgs,\r\n\tUmbEntityActionBase,\r\n\tUmbRequestReloadStructureForEntityEvent,\r\n} from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport { UMB_CURRENT_USER_CONTEXT } from '@umbraco-cms/backoffice/current-user';\r\n\r\nexport class UmbUnpublishDocumentEntityAction extends UmbEntityActionBase<never> {\r\n\tconstructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n\t\tsuper(host, args);\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tif (!this.args.unique) throw new Error('The document unique identifier is missing');\r\n\r\n\t\tconst languageRepository = new UmbLanguageCollectionRepository(this._host);\r\n\t\tconst { data: languageData } = await languageRepository.requestCollection({});\r\n\r\n\t\tconst documentRepository = new UmbDocumentDetailRepository(this._host);\r\n\t\tconst { data: documentData } = await documentRepository.requestByUnique(this.args.unique);\r\n\r\n\t\tif (!documentData) throw new Error('The document was not found');\r\n\r\n\t\tconst appLanguageContext = await this.getContext(UMB_APP_LANGUAGE_CONTEXT);\r\n\t\tconst appCulture = appLanguageContext.getAppCulture();\r\n\r\n\t\tconst currentUserContext = await this.getContext(UMB_CURRENT_USER_CONTEXT);\r\n\t\tconst currentUserAllowedLanguages = currentUserContext.getLanguages();\r\n\t\tconst currentUserHasAccessToAllLanguages = currentUserContext.getHasAccessToAllLanguages();\r\n\r\n\t\tif (currentUserAllowedLanguages === undefined) throw new Error('The current user languages are missing');\r\n\t\tif (currentUserHasAccessToAllLanguages === undefined)\r\n\t\t\tthrow new Error('The current user access to all languages is missing');\r\n\r\n\t\tconst options: Array<UmbDocumentVariantOptionModel> = documentData.variants.map<UmbDocumentVariantOptionModel>(\r\n\t\t\t(variant) => ({\r\n\t\t\t\tculture: variant.culture,\r\n\t\t\t\tsegment: variant.segment,\r\n\t\t\t\tlanguage: languageData?.items.find((language) => language.unique === variant.culture) ?? {\r\n\t\t\t\t\tname: appCulture!,\r\n\t\t\t\t\tentityType: 'language',\r\n\t\t\t\t\tfallbackIsoCode: null,\r\n\t\t\t\t\tisDefault: true,\r\n\t\t\t\t\tisMandatory: false,\r\n\t\t\t\t\tunique: appCulture!,\r\n\t\t\t\t},\r\n\t\t\t\tvariant,\r\n\t\t\t\tunique: new UmbVariantId(variant.culture, variant.segment).toString(),\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\t// Figure out the default selections\r\n\t\t// TODO: Missing features to pre-select the variant that fits with the variant-id of the tree/collection? (Again only relevant if the action is executed from a Tree or Collection) [NL]\r\n\t\tconst selection: Array<string> = [];\r\n\t\t// If the app language is one of the options, select it by default:\r\n\t\tif (appCulture && options.some((o) => o.unique === appCulture)) {\r\n\t\t\tselection.push(new UmbVariantId(appCulture, null).toString());\r\n\t\t} else {\r\n\t\t\t// If not, select the first option by default:\r\n\t\t\tselection.push(options[0].unique);\r\n\t\t}\r\n\r\n\t\tconst modalManagerContext = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n\t\tconst result = await modalManagerContext\r\n\t\t\t.open(this, UMB_DOCUMENT_UNPUBLISH_MODAL, {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tdocumentUnique: this.args.unique,\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tpickableFilter: (option) => {\r\n\t\t\t\t\t\tif (!option.culture) return false;\r\n\t\t\t\t\t\tif (currentUserHasAccessToAllLanguages) return true;\r\n\t\t\t\t\t\treturn currentUserAllowedLanguages.includes(option.culture);\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tvalue: { selection },\r\n\t\t\t})\r\n\t\t\t.onSubmit()\r\n\t\t\t.catch(() => undefined);\r\n\r\n\t\tif (!result?.selection.length) return;\r\n\r\n\t\tconst variantIds = result?.selection.map((x) => UmbVariantId.FromString(x)) ?? [];\r\n\r\n\t\tif (variantIds.length) {\r\n\t\t\tconst publishingRepository = new UmbDocumentPublishingRepository(this._host);\r\n\t\t\tconst { error } = await publishingRepository.unpublish(this.args.unique, variantIds);\r\n\r\n\t\t\tif (!error) {\r\n\t\t\t\tconst actionEventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\t\t\tconst event = new UmbRequestReloadStructureForEntityEvent({\r\n\t\t\t\t\tunique: this.args.unique,\r\n\t\t\t\t\tentityType: this.args.entityType,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tactionEventContext.dispatchEvent(event);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default UmbUnpublishDocumentEntityAction;\r\n"],"names":["UmbUnpublishDocumentEntityAction","UmbEntityActionBase","host","args","languageRepository","UmbLanguageCollectionRepository","languageData","documentRepository","UmbDocumentDetailRepository","documentData","appCulture","UMB_APP_LANGUAGE_CONTEXT","currentUserContext","UMB_CURRENT_USER_CONTEXT","currentUserAllowedLanguages","currentUserHasAccessToAllLanguages","options","variant","language","UmbVariantId","selection","o","result","UMB_MODAL_MANAGER_CONTEXT","UMB_DOCUMENT_UNPUBLISH_MODAL","option","variantIds","x","publishingRepository","UmbDocumentPublishingRepository","error","actionEventContext","UMB_ACTION_EVENT_CONTEXT","event","UmbRequestReloadStructureForEntityEvent"],"mappings":";;;;;;;;;;;;AAgBO,MAAMA,UAAyCC,EAA2B;AAAA,EAChF,YAAYC,GAAyBC,GAAkC;AACtE,UAAMD,GAAMC,CAAI;AAAA,EAAA;AAAA,EAGjB,MAAe,UAAU;AACxB,QAAI,CAAC,KAAK,KAAK,OAAc,OAAA,IAAI,MAAM,2CAA2C;AAElF,UAAMC,IAAqB,IAAIC,EAAgC,KAAK,KAAK,GACnE,EAAE,MAAMC,EAAa,IAAI,MAAMF,EAAmB,kBAAkB,EAAE,GAEtEG,IAAqB,IAAIC,EAA4B,KAAK,KAAK,GAC/D,EAAE,MAAMC,MAAiB,MAAMF,EAAmB,gBAAgB,KAAK,KAAK,MAAM;AAExF,QAAI,CAACE,EAAoB,OAAA,IAAI,MAAM,4BAA4B;AAGzD,UAAAC,KADqB,MAAM,KAAK,WAAWC,CAAwB,GACnC,cAAc,GAE9CC,IAAqB,MAAM,KAAK,WAAWC,CAAwB,GACnEC,IAA8BF,EAAmB,aAAa,GAC9DG,IAAqCH,EAAmB,2BAA2B;AAEzF,QAAIE,MAAgC,OAAiB,OAAA,IAAI,MAAM,wCAAwC;AACvG,QAAIC,MAAuC;AACpC,YAAA,IAAI,MAAM,qDAAqD;AAEhE,UAAAC,IAAgDP,EAAa,SAAS;AAAA,MAC3E,CAACQ,OAAa;AAAA,QACb,SAASA,EAAQ;AAAA,QACjB,SAASA,EAAQ;AAAA,QACjB,UAAUX,GAAc,MAAM,KAAK,CAACY,MAAaA,EAAS,WAAWD,EAAQ,OAAO,KAAK;AAAA,UACxF,MAAMP;AAAA,UACN,YAAY;AAAA,UACZ,iBAAiB;AAAA,UACjB,WAAW;AAAA,UACX,aAAa;AAAA,UACb,QAAQA;AAAA,QACT;AAAA,QACA,SAAAO;AAAA,QACA,QAAQ,IAAIE,EAAaF,EAAQ,SAASA,EAAQ,OAAO,EAAE,SAAS;AAAA,MACrE;AAAA,IACD,GAIMG,IAA2B,CAAC;AAE9B,IAAAV,KAAcM,EAAQ,KAAK,CAACK,MAAMA,EAAE,WAAWX,CAAU,IAC5DU,EAAU,KAAK,IAAID,EAAaT,GAAY,IAAI,EAAE,UAAU,IAG5DU,EAAU,KAAKJ,EAAQ,CAAC,EAAE,MAAM;AAIjC,UAAMM,IAAS,OADa,MAAM,KAAK,WAAWC,CAAyB,GAEzE,KAAK,MAAMC,GAA8B;AAAA,MACzC,MAAM;AAAA,QACL,gBAAgB,KAAK,KAAK;AAAA,QAC1B,SAAAR;AAAA,QACA,gBAAgB,CAACS,MACXA,EAAO,UACRV,IAA2C,KACxCD,EAA4B,SAASW,EAAO,OAAO,IAF9B;AAAA,MAI9B;AAAA,MACA,OAAO,EAAE,WAAAL,EAAU;AAAA,IACnB,CAAA,EACA,SAAA,EACA,MAAM,MAAM;AAAA,KAAS;AAEnB,QAAA,CAACE,GAAQ,UAAU,OAAQ;AAEzB,UAAAI,IAAaJ,GAAQ,UAAU,IAAI,CAACK,MAAMR,EAAa,WAAWQ,CAAC,CAAC,KAAK,CAAC;AAEhF,QAAID,EAAW,QAAQ;AACtB,YAAME,IAAuB,IAAIC,EAAgC,KAAK,KAAK,GACrE,EAAE,OAAAC,EAAU,IAAA,MAAMF,EAAqB,UAAU,KAAK,KAAK,QAAQF,CAAU;AAEnF,UAAI,CAACI,GAAO;AACX,cAAMC,IAAqB,MAAM,KAAK,WAAWC,CAAwB,GACnEC,IAAQ,IAAIC,EAAwC;AAAA,UACzD,QAAQ,KAAK,KAAK;AAAA,UAClB,YAAY,KAAK,KAAK;AAAA,QAAA,CACtB;AAED,QAAAH,EAAmB,cAAcE,CAAK;AAAA,MAAA;AAAA,IACvC;AAAA,EACD;AAEF;"}