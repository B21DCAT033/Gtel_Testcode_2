{"version":3,"file":"unpublish.bulk-action-DfmMY9me.js","sources":["../../../src/packages/documents/documents/publishing/unpublish/entity-bulk-action/unpublish.bulk-action.ts"],"sourcesContent":["import { UmbUnpublishDocumentEntityAction } from '../entity-action/index.js';\r\nimport type { UmbDocumentVariantOptionModel } from '../../../types.js';\r\nimport { UMB_DOCUMENT_ENTITY_TYPE, UMB_DOCUMENT_UNPUBLISH_MODAL } from '../../../constants.js';\r\nimport { UmbDocumentPublishingRepository } from '../../repository/index.js';\r\nimport { UMB_CONFIRM_MODAL, UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbEntityBulkActionBase } from '@umbraco-cms/backoffice/entity-bulk-action';\r\nimport { UMB_APP_LANGUAGE_CONTEXT, UmbLanguageCollectionRepository } from '@umbraco-cms/backoffice/language';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\nimport { UMB_ENTITY_CONTEXT } from '@umbraco-cms/backoffice/entity';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport { UmbRequestReloadChildrenOfEntityEvent } from '@umbraco-cms/backoffice/entity-action';\r\n\r\nexport class UmbDocumentUnpublishEntityBulkAction extends UmbEntityBulkActionBase<object> {\r\n\tasync execute() {\r\n\t\tconst entityContext = await this.getContext(UMB_ENTITY_CONTEXT);\r\n\t\tconst entityType = entityContext.getEntityType();\r\n\t\tconst unique = entityContext.getUnique();\r\n\r\n\t\tif (!entityType) throw new Error('Entity type not found');\r\n\t\tif (unique === undefined) throw new Error('Entity unique not found');\r\n\r\n\t\t// If there is only one selection, we can refer to the regular unpublish entity action:\r\n\t\tif (this.selection.length === 1) {\r\n\t\t\tconst action = new UmbUnpublishDocumentEntityAction(this._host, {\r\n\t\t\t\tunique: this.selection[0],\r\n\t\t\t\tentityType: UMB_DOCUMENT_ENTITY_TYPE,\r\n\t\t\t\tmeta: {} as never,\r\n\t\t\t});\r\n\t\t\tawait action.execute();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst languageRepository = new UmbLanguageCollectionRepository(this._host);\r\n\t\tconst { data: languageData } = await languageRepository.requestCollection({});\r\n\r\n\t\tconst options: UmbDocumentVariantOptionModel[] = (languageData?.items ?? []).map((language) => ({\r\n\t\t\tlanguage,\r\n\t\t\tvariant: {\r\n\t\t\t\tname: language.name,\r\n\t\t\t\tculture: language.unique,\r\n\t\t\t\tstate: null,\r\n\t\t\t\tcreateDate: null,\r\n\t\t\t\tpublishDate: null,\r\n\t\t\t\tupdateDate: null,\r\n\t\t\t\tsegment: null,\r\n\t\t\t\tscheduledPublishDate: null,\r\n\t\t\t\tscheduledUnpublishDate: null,\r\n\t\t\t},\r\n\t\t\tunique: new UmbVariantId(language.unique, null).toString(),\r\n\t\t\tculture: language.unique,\r\n\t\t\tsegment: null,\r\n\t\t}));\r\n\r\n\t\tconst modalManagerContext = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n\r\n\t\tconst eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\tconst event = new UmbRequestReloadChildrenOfEntityEvent({\r\n\t\t\tentityType,\r\n\t\t\tunique,\r\n\t\t});\r\n\r\n\t\t// If there is only one language available, we can skip the modal and unpublish directly:\r\n\t\tif (options.length === 1) {\r\n\t\t\tconst localizationController = new UmbLocalizationController(this._host);\r\n\t\t\tconst confirm = await modalManagerContext\r\n\t\t\t\t.open(this, UMB_CONFIRM_MODAL, {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\theadline: localizationController.term('actions_unpublish'),\r\n\t\t\t\t\t\tcontent: localizationController.term('prompt_confirmListViewUnpublish'),\r\n\t\t\t\t\t\tcolor: 'warning',\r\n\t\t\t\t\t\tconfirmLabel: localizationController.term('actions_unpublish'),\r\n\t\t\t\t\t},\r\n\t\t\t\t})\r\n\t\t\t\t.onSubmit()\r\n\t\t\t\t.catch(() => false);\r\n\r\n\t\t\tif (confirm !== false) {\r\n\t\t\t\tconst variantId = new UmbVariantId(options[0].language.unique, null);\r\n\t\t\t\tconst publishingRepository = new UmbDocumentPublishingRepository(this._host);\r\n\t\t\t\tfor (let i = 0; i < this.selection.length; i++) {\r\n\t\t\t\t\tconst id = this.selection[i];\r\n\t\t\t\t\tawait publishingRepository.unpublish(id, [variantId]);\r\n\t\t\t\t}\r\n\r\n\t\t\t\teventContext.dispatchEvent(event);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Figure out the default selections\r\n\t\t// TODO: Missing features to pre-select the variant that fits with the variant-id of the tree/collection? (Again only relevant if the action is executed from a Tree or Collection) [NL]\r\n\t\tconst selection: Array<string> = [];\r\n\t\tconst context = await this.getContext(UMB_APP_LANGUAGE_CONTEXT);\r\n\t\tconst appCulture = context.getAppCulture();\r\n\t\t// If the app language is one of the options, select it by default:\r\n\t\tif (appCulture && options.some((o) => o.unique === appCulture)) {\r\n\t\t\tselection.push(new UmbVariantId(appCulture, null).toString());\r\n\t\t}\r\n\r\n\t\tconst result = await modalManagerContext\r\n\t\t\t.open(this, UMB_DOCUMENT_UNPUBLISH_MODAL, {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\toptions,\r\n\t\t\t\t},\r\n\t\t\t\tvalue: { selection },\r\n\t\t\t})\r\n\t\t\t.onSubmit()\r\n\t\t\t.catch(() => undefined);\r\n\r\n\t\tif (!result?.selection.length) return;\r\n\r\n\t\tconst variantIds = result?.selection.map((x) => UmbVariantId.FromString(x)) ?? [];\r\n\r\n\t\tconst repository = new UmbDocumentPublishingRepository(this._host);\r\n\r\n\t\tif (variantIds.length) {\r\n\t\t\tfor (const unique of this.selection) {\r\n\t\t\t\tawait repository.unpublish(unique, variantIds);\r\n\t\t\t\teventContext.dispatchEvent(event);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport { UmbDocumentUnpublishEntityBulkAction as api };\r\n"],"names":["UmbDocumentUnpublishEntityBulkAction","UmbEntityBulkActionBase","entityContext","UMB_ENTITY_CONTEXT","entityType","unique","UmbUnpublishDocumentEntityAction","UMB_DOCUMENT_ENTITY_TYPE","languageRepository","UmbLanguageCollectionRepository","languageData","options","language","UmbVariantId","modalManagerContext","UMB_MODAL_MANAGER_CONTEXT","eventContext","UMB_ACTION_EVENT_CONTEXT","event","UmbRequestReloadChildrenOfEntityEvent","localizationController","UmbLocalizationController","UMB_CONFIRM_MODAL","variantId","publishingRepository","UmbDocumentPublishingRepository","i","id","selection","appCulture","UMB_APP_LANGUAGE_CONTEXT","o","result","UMB_DOCUMENT_UNPUBLISH_MODAL","variantIds","x","repository"],"mappings":"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"}