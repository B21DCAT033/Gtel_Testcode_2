{"version":3,"file":"tiny-mce-multi-url-picker.plugin-BZXbUwnB.js","sources":["../../../src/packages/multi-url-picker/tiny-mce-plugin/tiny-mce-multi-url-picker.plugin.ts"],"sourcesContent":["import { UMB_LINK_PICKER_MODAL } from '../link-picker-modal/link-picker-modal.token.js';\r\nimport type { UmbLinkPickerLink, UmbLinkPickerLinkType } from '../link-picker-modal/types.js';\r\nimport type { UmbLinkPickerModalValue } from '../link-picker-modal/link-picker-modal.token.js';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\nimport { UmbTinyMcePluginBase } from '@umbraco-cms/backoffice/tiny-mce';\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport type { TinyMcePluginArguments } from '@umbraco-cms/backoffice/tiny-mce';\r\n\r\ntype AnchorElementAttributes = {\r\n\t'data-anchor'?: string | null;\r\n\thref?: string | null;\r\n\ttarget?: string | null;\r\n\ttext?: string;\r\n\ttitle?: string | null;\r\n\ttype?: UmbLinkPickerLinkType;\r\n\trel?: string | null;\r\n};\r\n\r\nexport default class UmbTinyMceMultiUrlPickerPlugin extends UmbTinyMcePluginBase {\r\n\t#linkPickerData?: UmbLinkPickerModalValue;\r\n\r\n\t#anchorElement?: HTMLAnchorElement;\r\n\r\n\tconstructor(args: TinyMcePluginArguments) {\r\n\t\tsuper(args);\r\n\r\n\t\tconst localize = new UmbLocalizationController(args.host);\r\n\r\n\t\tthis.editor.ui.registry.addToggleButton('link', {\r\n\t\t\ticon: 'link',\r\n\t\t\ttooltip: localize.term('general_addEditLink'),\r\n\t\t\tonAction: () => this.showDialog(),\r\n\t\t\tonSetup: (api) => {\r\n\t\t\t\tconst changed = this.editor.selection.selectorChangedWithUnbind('a', (state) => api.setActive(state));\r\n\t\t\t\treturn () => changed.unbind();\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tthis.editor.ui.registry.addToggleButton('unlink', {\r\n\t\t\ticon: 'unlink',\r\n\t\t\ttooltip: localize.term('general_removeLink'),\r\n\t\t\tonAction: () => args.editor.execCommand('unlink'),\r\n\t\t\tonSetup: (api) => {\r\n\t\t\t\tconst changed = this.editor.selection.selectorChangedWithUnbind('a', (state) => api.setActive(state));\r\n\t\t\t\treturn () => changed.unbind();\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tasync showDialog() {\r\n\t\tconst selectedElm = this.editor.selection.getNode();\r\n\t\tthis.#anchorElement = this.editor.dom.getParent(selectedElm, 'a[href]') as HTMLAnchorElement;\r\n\r\n\t\tif (!this.#anchorElement) {\r\n\t\t\tthis.#openLinkPicker({ name: this.editor.selection.getContent({ format: 'text' }) });\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tlet url = this.#anchorElement.getAttribute('href') ?? this.#anchorElement.href ?? '';\r\n\r\n\t\tconst queryString = this.#anchorElement.getAttribute('data-anchor') ?? '';\r\n\t\tif (queryString && url.endsWith(queryString)) {\r\n\t\t\turl = url.substring(0, url.indexOf(queryString));\r\n\t\t}\r\n\r\n\t\tconst currentTarget: UmbLinkPickerLink = {\r\n\t\t\tname: this.#anchorElement.title || this.#anchorElement.textContent,\r\n\t\t\ttarget: this.#anchorElement.target,\r\n\t\t\tqueryString: queryString,\r\n\t\t\ttype: (this.#anchorElement.type as UmbLinkPickerLinkType) ?? 'external',\r\n\t\t\tunique: url.includes('localLink:') ? url.substring(url.indexOf(':') + 1, url.indexOf('}')) : null,\r\n\t\t\turl: url,\r\n\t\t};\r\n\r\n\t\tthis.#openLinkPicker(currentTarget);\r\n\t}\r\n\r\n\tasync #openLinkPicker(currentTarget?: UmbLinkPickerLink) {\r\n\t\tconst modalManager = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n\t\tconst modalHandler = modalManager.open(this, UMB_LINK_PICKER_MODAL, {\r\n\t\t\tdata: {\r\n\t\t\t\tconfig: {},\r\n\t\t\t\tindex: null,\r\n\t\t\t\tisNew: currentTarget?.url === undefined,\r\n\t\t\t},\r\n\t\t\tvalue: {\r\n\t\t\t\tlink: currentTarget ?? {},\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tif (!modalHandler) return;\r\n\r\n\t\tconst linkPickerData = await modalHandler.onSubmit().catch(() => undefined);\r\n\t\tif (!linkPickerData) return;\r\n\r\n\t\t// TODO: This is a workaround for the issue where the link picker modal is returning a frozen object, and we need to extract the link into smaller parts to avoid the frozen object issue.\r\n\t\tthis.#linkPickerData = { link: { ...linkPickerData.link } };\r\n\r\n\t\tthis.#updateLink();\r\n\t}\r\n\r\n\t#createElemAttributes() {\r\n\t\tconst link = this.#linkPickerData!.link;\r\n\r\n\t\tconst anchor: AnchorElementAttributes = {\r\n\t\t\thref: link.url ?? '',\r\n\t\t\ttitle: link.name ?? link.url ?? '',\r\n\t\t\ttarget: link.target,\r\n\t\t\ttype: link.type ?? 'external',\r\n\t\t\trel: link.target === '_blank' ? 'noopener' : null,\r\n\t\t};\r\n\r\n\t\tif (link.queryString) {\r\n\t\t\tanchor['data-anchor'] = link.queryString;\r\n\r\n\t\t\tif (link.queryString.startsWith('?')) {\r\n\t\t\t\tanchor.href += !anchor.href ? '/' + link.queryString : link.queryString;\r\n\t\t\t} else if (link.queryString.startsWith('#')) {\r\n\t\t\t\tanchor.href += link.queryString;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn anchor;\r\n\t}\r\n\r\n\t#insertLink() {\r\n\t\tif (this.#anchorElement) {\r\n\t\t\tthis.editor.dom.setAttribs(this.#anchorElement, this.#createElemAttributes());\r\n\t\t\tthis.editor.selection.select(this.#anchorElement);\r\n\t\t\tthis.editor.execCommand('mceEndTyping');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// If there is no selected content, we can't insert a link\r\n\t\t// as TinyMCE needs selected content for this, so instead we\r\n\t\t// create a new dom element and insert it, using the chosen\r\n\t\t// link name as the content.\r\n\r\n\t\tif (this.editor.selection.getContent() !== '') {\r\n\t\t\tthis.editor.execCommand('CreateLink', false, this.#createElemAttributes());\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Using the target url as a fallback, as href might be confusing with a local link\r\n\t\tconst linkContent =\r\n\t\t\ttypeof this.#linkPickerData?.link.name !== 'undefined' && this.#linkPickerData?.link.name !== ''\r\n\t\t\t\t? this.#linkPickerData?.link.name\r\n\t\t\t\t: this.#linkPickerData?.link.url;\r\n\r\n\t\t// only insert if link has content\r\n\t\tif (linkContent) {\r\n\t\t\tconst domElement = this.editor.dom.createHTML('a', this.#createElemAttributes(), linkContent);\r\n\t\t\tthis.editor.execCommand('mceInsertContent', false, domElement);\r\n\t\t}\r\n\t}\r\n\r\n\t#updateLink() {\r\n\t\t// if an anchor exists, check that it is appropriately prefixed\r\n\t\tif (\r\n\t\t\tthis.#linkPickerData?.link.queryString &&\r\n\t\t\t!this.#linkPickerData.link.queryString.startsWith('?') &&\r\n\t\t\t!this.#linkPickerData.link.queryString.startsWith('#')\r\n\t\t) {\r\n\t\t\tthis.#linkPickerData.link.queryString =\r\n\t\t\t\t(this.#linkPickerData.link.queryString.startsWith('=') ? '#' : '?') + this.#linkPickerData.link.queryString;\r\n\t\t}\r\n\r\n\t\t// the href might be an external url, so check the value for an anchor/qs\r\n\t\t// href has the anchor re-appended later, hence the reset here to avoid duplicating the anchor\r\n\t\tif (this.#linkPickerData && !this.#linkPickerData?.link.queryString) {\r\n\t\t\tconst urlParts = this.#linkPickerData?.link.url?.split(/(#|\\?)/);\r\n\t\t\tif (urlParts?.length === 3) {\r\n\t\t\t\tthis.#linkPickerData.link.url = urlParts[0];\r\n\t\t\t\tthis.#linkPickerData.link.queryString = urlParts[1] + urlParts[2];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\t!this.#linkPickerData?.link.url &&\r\n\t\t\t!this.#linkPickerData?.link.queryString &&\r\n\t\t\t!this.#linkPickerData?.link.unique\r\n\t\t) {\r\n\t\t\tthis.editor.execCommand('unlink');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t//if we have an id, it must be a locallink:id\r\n\t\tif (this.#linkPickerData?.link.unique) {\r\n\t\t\tthis.#linkPickerData.link.url = '/{localLink:' + this.#linkPickerData.link.unique + '}';\r\n\t\t\tthis.#insertLink();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (!this.#linkPickerData?.link.url) {\r\n\t\t\tthis.#linkPickerData.link.url = '';\r\n\t\t}\r\n\r\n\t\t// Is email and not //user@domain.com and protocol (e.g. mailto:, sip:) is not specified\r\n\t\tif (\r\n\t\t\tthis.#linkPickerData?.link.url.includes('@') &&\r\n\t\t\t!this.#linkPickerData.link.url.includes('//') &&\r\n\t\t\t!this.#linkPickerData.link.url.includes(':')\r\n\t\t) {\r\n\t\t\t// assume it's a mailto link\r\n\t\t\tthis.#linkPickerData.link.url = 'mailto:' + this.#linkPickerData?.link.url;\r\n\t\t\tthis.#insertLink();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Is www. prefixed\r\n\t\tif (/^\\s*www\\./i.test(this.#linkPickerData?.link.url)) {\r\n\t\t\tthis.#linkPickerData.link.url = 'http://' + this.#linkPickerData.link.url;\r\n\t\t}\r\n\r\n\t\tthis.#insertLink();\r\n\t}\r\n}\r\n"],"names":["UmbTinyMceMultiUrlPickerPlugin","UmbTinyMcePluginBase","#linkPickerData","#anchorElement","args","localize","UmbLocalizationController","api","changed","state","selectedElm","#openLinkPicker","url","queryString","currentTarget","modalHandler","UMB_MODAL_MANAGER_CONTEXT","UMB_LINK_PICKER_MODAL","linkPickerData","#updateLink","#createElemAttributes","link","anchor","#insertLink","linkContent","domElement","urlParts"],"mappings":"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"}